# Feature Specification: Improve Frontend Information Architecture & UX

**Feature Branch**: `003-improve-frontend-ux`
**Created**: 2026-02-21
**Status**: Draft
**Input**: User description: "フロントエンドの情報設計を見直してブラッシュアップしたい — 6つの改善提案（現在年の常設表示、コントロールバー統合、選択領土マップハイライト、初回ヒントUI、モバイルInfoPanelボトムシート化、ビジュアル階層見直し）"

## Background

World History Map は、歴史的な領土を年代別にインタラクティブに探索できる地図アプリケーション。現在のUIは機能的に動作するが、情報設計面で以下の課題がある:

- ユーザーが「今何年を見ているのか」を把握しづらい
- 初回訪問時に操作方法の手がかりがない
- コントロールボタンの配置が画面サイズにより不整合
- 選択中の領土がマップ上で視覚的にハイライトされない
- モバイル端末でInfoPanelが画面を大きく覆う
- UI要素間の視覚的重要度の差が不十分

## Scope Decisions

以下の改善案は検討の結果、今回のスコープから除外した:

- **年代セレクターへの時代区分ラベル追加**: 時代区分（古代・中世・近世等）は地域によって定義が異なり、世界史を扱うアプリで単一の区分を適用することは不正確。採用しない
- **InfoPanel内での年代遷移ナビゲーション**: 現在のデータに`relatedYears`フィールドが存在せず、前提となる機能が未実装。将来的に再検討する

## Clarifications

### Session 2026-02-21

- Q: 初回ヒントUIの表示形式は？ → A: トースト型（画面下部に短い通知バーとして表示。マップの視認性を最大限維持）
- Q: ボトムシートのスナップポイント動作は？ → A: 単一高さ（画面の60%で固定）。開/閉の2状態のみ
- Q: 選択領土ハイライトの視覚スタイルは？ → A: 白色アウトライン（3-4px）＋領土内部を半透明白（opacity 0.15程度）で塗りつぶし
- Q: 年代表示の更新アニメーション種別は？ → A: フェード（旧数値フェードアウト→新数値フェードイン、duration 200-300ms）
- Q: ビジュアル階層の具体的な差異基準は？ → A: 補助ツールのアイコン色を控えめ化（text-white/60等）し、ボタン背景は不透明のまま維持

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 現在の年代を常に把握できる (Priority: P1)

ユーザーとして、地図を操作中に「今何年を見ているか」を常に確認したい。地図操作に集中していても、画面上部に現在の年代が大きく表示されていることで、迷子にならず安心して探索できる。

**Why this priority**: 情報設計の最も根本的な問題。ユーザーが「今どこにいるか」を把握できないと、他のすべてのUX改善の効果が薄れる。最小のコストで最大のインパクトがある。

**Independent Test**: 地図を開いて年代を切り替えた時、画面上に現在の年代が即座に更新されて表示されることを確認する。

**Acceptance Scenarios**:

1. **Given** アプリ起動直後（デフォルト年1650年）, **When** マップが表示される, **Then** 画面上部中央に「1650」が大きく表示される
2. **Given** 年代セレクターで別の年（例: 1900年）を選択, **When** 年代が切り替わる, **Then** 上部の年代表示が「1900」にフェードアニメーション（200-300ms）で更新される
3. **Given** 年代表示が表示されている状態, **When** マップをズーム・パンで操作する, **Then** 年代表示は常に画面上に表示され続ける
4. **Given** 紀元前の年代を選択（例: 前200年）, **When** 年代表示を見る, **Then** 「前200」と表示される

---

### User Story 2 - コントロールボタンが整理されている (Priority: P1)

ユーザーとして、地図の補助ツール（投影法切替・サイト情報・ソースコード）が一箇所にまとまっていてほしい。画面サイズによってボタンが上や下に飛ばず、常に同じ場所にグループ化されていることで、操作に迷わない。

**Why this priority**: 現在のレイアウトでは投影法トグルと情報/GitHubリンクがブレイクポイントにより位置が分散し、一貫性がない。低コストで修正でき、画面の整理に直結する。

**Independent Test**: デスクトップとモバイルの両方で画面右上にすべてのコントロールがグループ化されていることを確認する。

**Acceptance Scenarios**:

1. **Given** デスクトップ画面幅（1024px以上）, **When** ページを表示する, **Then** 投影法切替・情報ボタン・GitHubリンクが右上にグループ化されて表示される
2. **Given** モバイル画面幅（375px）, **When** ページを表示する, **Then** 同じボタン群が右上に縦並びで表示される（位置の移動なし）
3. **Given** コントロールバーが表示されている状態, **When** 画面サイズをリサイズする, **Then** ボタン群のレイアウトは変わりうるが、位置（右上）は維持される

---

### User Story 3 - 選択中の領土がマップ上で分かる (Priority: P2)

ユーザーとして、情報パネルで詳細を読んでいる領土がマップ上のどこなのか、視覚的にハイライト表示されてほしい。パネルの情報と地図上の位置を対応づけやすくなる。

**Why this priority**: 情報パネルとマップの連携を強化し、「パネルの情報がどの領土に対応するか」を直感的に理解できるようにする。地図アプリとして重要な空間認知を支援する。

**Independent Test**: 領土をクリックして情報パネルが開いた時に、マップ上の該当領土に目立つ視覚的ハイライト（枠線やアウトライン）が表示されることを確認する。

**Acceptance Scenarios**:

1. **Given** マップが表示されている状態, **When** 領土をクリックして情報パネルが開く, **Then** クリックした領土の境界線が白色アウトライン（3-4px）で強調され、領土内部が半透明白（opacity 0.15）で塗りつぶされる
2. **Given** 領土がハイライトされている状態, **When** 情報パネルを閉じる, **Then** ハイライトが解除される
3. **Given** 領土Aがハイライトされている状態, **When** 別の領土Bをクリックする, **Then** 領土Aのハイライトが解除され、領土Bがハイライトされる
4. **Given** 領土がハイライトされている状態, **When** 年代を切り替える, **Then** 同じ名前の領土が新しい年代にも存在すればハイライトが維持され、存在しなければハイライトが解除される

---

### User Story 4 - 初回訪問時の操作ガイダンス (Priority: P3)

初めてアプリを訪問したユーザーとして、「領土をクリックすると詳細が見られる」「下部で年代を切り替えられる」といった基本操作のヒントが表示されてほしい。すぐに消せること、二度目以降は表示されないこと。

**Why this priority**: 新規ユーザーのオンボーディングを改善する。ただし、アプリの機能が直感的に改善されれば自然と不要になる可能性もあるため、他の改善が先。

**Independent Test**: 初回訪問時にヒントが表示されること、閉じた後に再表示されないことを確認する。

**Acceptance Scenarios**:

1. **Given** 初めてアプリを訪問（ローカルストレージに記録なし）, **When** マップが読み込み完了する, **Then** 画面下部にトースト形式で操作ヒント（例: 「領土をクリックして詳細を見る」「下部で年代を切り替え」）が表示される
2. **Given** ヒントが表示されている状態, **When** ヒントを閉じるか、マップをクリックする, **Then** ヒントが消える
3. **Given** 一度ヒントを閉じた後, **When** ページをリロードする, **Then** ヒントは表示されない（ローカルストレージで管理）
4. **Given** ヒントが表示されている状態, **When** 10秒経過する, **Then** ヒントが自動的にフェードアウトする

---

### User Story 5 - モバイルでの情報パネルが使いやすい (Priority: P3)

モバイル端末のユーザーとして、領土情報パネルが画面下部からスライドアップする「ボトムシート」形式で表示されてほしい。マップの一部が上部に見え続けることで、空間的なコンテキストを失わない。

**Why this priority**: モバイルUXの大幅改善になるが、実装コストが比較的高く、デスクトップ版には影響しない。P1-P2の改善が完了した後に取り組むのが適切。

**Independent Test**: モバイル画面幅で領土をクリックし、パネルが下部からスライドアップして地図の上部が見える状態を確認する。

**Acceptance Scenarios**:

1. **Given** モバイル画面幅（768px未満）, **When** 領土をクリック, **Then** 情報パネルが画面下部からスライドアップして画面の60%の高さで固定表示される
2. **Given** ボトムシートが表示されている状態, **When** シートを下方向にスワイプ, **Then** パネルが閉じる
3. **Given** デスクトップ画面幅（768px以上）, **When** 領土をクリック, **Then** 従来通り左側のサイドパネルとして表示される
4. **Given** ボトムシートが表示されている状態, **When** マップの見えている上部をタップ, **Then** パネルが閉じる

---

### User Story 6 - UI要素の視覚的階層が明確 (Priority: P3)

ユーザーとして、年代表示や年代セレクター（主要ナビゲーション）と投影法切替やGitHubリンク（補助ツール）が視覚的に区別されてほしい。重要な要素が目立ち、補助的な要素は控えめに見えることで、画面の情報を素早く把握できる。

**Why this priority**: 視覚的な洗練。他の構造的改善と併せて行うと効果的だが、単独でも画面の見やすさが向上する。

**Independent Test**: 画面全体を見て、主要UIと補助UIの視覚的な差異（サイズ・色・不透明度の違い）が明確であることを確認する。

**Acceptance Scenarios**:

1. **Given** アプリが表示されている状態, **When** 画面全体を見る, **Then** 年代表示（現在年）が最も目立つ要素であり、年代セレクターが次に目立つ
2. **Given** アプリが表示されている状態, **When** 補助ツール（投影法切替・情報・GitHub）を見る, **Then** アイコン色が控えめ（text-white/60等）で、主要ナビゲーションより視覚的に抑えられて表示されている
3. **Given** 情報パネルが開いている状態, **When** パネルとコントロールバーを比較する, **Then** パネルが視覚的により前面にあり、コントロールバーは控えめ

---

### Edge Cases

- 利用可能な年代データが1件のみの場合、年代セレクターの前後ナビゲーションはどう表示されるか？→ 前後ボタンは無効化（現行動作を維持）
- 初回ヒントのローカルストレージがブラウザ設定で無効な場合は？→ ヒントが毎回表示されるが、機能に影響はない（graceful degradation）
- 同じ名前の領土が年代切替で形状が大きく変わった場合のハイライト表示は？→ 新しい年代のデータに基づいてハイライトし直す（NAME属性で照合）
- ボトムシートの高さがコンテンツ量に対して不足する場合は？→ シート内スクロールで対応（最大高さは画面の80%）

## Requirements *(mandatory)*

### Functional Requirements

**現在年の常設表示**
- **FR-001**: 画面上部中央に現在選択中の年代を常に表示しなければならない
- **FR-002**: 年代切替時に、年代表示がフェードアニメーション（200-300ms）で更新されなければならない
- **FR-003**: 紀元前の年代は「前〇〇」の形式で表示しなければならない

**コントロールバー統合**
- **FR-004**: 投影法切替・サイト情報・ソースコードリンクのボタン群を画面右上に統合して配置しなければならない
- **FR-005**: コントロールバーの位置は画面サイズにかかわらず右上を維持しなければならない

**選択領土マップハイライト**
- **FR-006**: 選択中の領土をマップ上で強調表示しなければならない（白色アウトライン3-4px＋半透明白フィルopacity 0.15）
- **FR-007**: パネルを閉じた時、ハイライトを解除しなければならない
- **FR-008**: 年代切替時、同名の領土が存在する場合はハイライトを維持し、存在しない場合は解除しなければならない

**初回ヒントUI**
- **FR-009**: 初回訪問時に基本操作のヒントをトースト形式（画面下部の通知バー）で表示しなければならない
- **FR-010**: ヒントはユーザー操作または一定時間経過で非表示にしなければならない
- **FR-011**: ヒントの表示済み状態をローカルストレージで永続化しなければならない

**モバイルInfoPanelボトムシート**
- **FR-012**: モバイル画面幅（768px未満）で領土情報パネルをボトムシート形式（画面高さの60%固定、開/閉の2状態）で表示しなければならない
- **FR-013**: ボトムシートは下方向スワイプで閉じられなければならない
- **FR-014**: デスクトップ画面幅では従来通りサイドパネル形式を維持しなければならない

**ビジュアル階層**
- **FR-015**: 主要ナビゲーション（年代表示・年代セレクター）と補助ツール（コントロールバー）に視覚的な差異を設けなければならない。補助ツールはアイコン色を控えめ化（text-white/60等）し、ボタン背景は不透明を維持する

### Key Entities

- **操作ヒント (Onboarding Hint)**: 初回訪問ユーザーに表示する操作ガイダンス。表示形式: トースト（画面下部通知バー）。属性: メッセージテキスト、表示状態、永続化キー

## Assumptions

- ボトムシートのブレイクポイントは768px（md）とする（Tailwindの標準ブレイクポイントに合わせる）
- 初回ヒントの自動消去タイミングは10秒とする
- 領土のハイライトは白色アウトライン（3-4px）＋半透明白フィル（opacity 0.15）とする
- 年代表示のアニメーションは`prefers-reduced-motion`を尊重する

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーが地図操作中いつでも、画面を見て1秒以内に「現在何年を見ているか」を把握できる
- **SC-002**: 初回訪問ユーザーの80%以上が、ヒントを見てから30秒以内に領土クリックまたは年代切替のいずれかを実行できる
- **SC-003**: モバイル端末（375px幅）で情報パネルが開いている状態でも、マップの20%以上が視認可能な状態が維持される
- **SC-004**: 画面全体のUI要素を一覧した時、主要ナビゲーション要素が補助ツール要素より視覚的に大きく・目立つ状態になっている
- **SC-005**: すべてのインタラクティブ要素がキーボード操作可能で、フォーカスリングが視認できる（アクセシビリティ維持）
