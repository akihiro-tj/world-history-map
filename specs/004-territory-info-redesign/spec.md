# 機能仕様書: 領土情報パネル 情報設計リデザイン

**機能ブランチ**: `004-territory-info-redesign`
**作成日**: 2026-02-28
**ステータス**: ドラフト
**入力**: "territory-info-panel.tsx の情報設計を見直し。世界史学習ユーザーの立場からユースケースを検討し、データ項目の構造・表示方法のあるべき姿を定義する。"

## 背景

現在の領土情報パネルは、ユーザーが地図上の領土をクリックした際に AI 生成の歴史情報を表示する。現在のデータモデルには以下の構造的課題がある:

- `facts` フィールドが非構造化の `string[]` であり、異なるカテゴリの情報（首都、政体、指導者、人口、特徴）が `"首都: パリ"` のような自由テキスト形式で混在している
- `keyEvents` のタイムラインが領土の全歴史にわたっており、選択年との時間的関連性が区別されていない
- 選択された時点における領土の状況を説明する文脈情報がない
- データの少ない領土で `"首都: 不明"` のような無意味な項目が表示される
- 情報の階層がなく、すべてのデータが重要度に関係なく同じ視覚的重みで表示されている

## Clarifications

### Session 2026-03-01

- Q: 再作成後の目標領土数は？ → A: 50〜70領土（教科書の太字レベル）
- Q: データの記述言語は？ → A: すべて日本語（profile の値、context テキスト、keyEvents の説明すべて）
- Q: タイムラインの「current」分類ルールは？ → A: 完全一致のみ（選択年 = イベント年のときだけ current）
- Q: context テキストの長さ制約は？ → A: 2〜3文（100〜200字程度）
- Q: プロフィールの「備考」フィールドの用途は？ → A: 削除。4フィールド（首都・政体・指導者・宗教）に限定する
- Q: 人口フィールドは必要か？ → A: 削除。前近代のデータは推定値の幅が大きく偽の精度感を与える。重要な場面では context テキストで文脈と共に記述する
- Q: 王朝フィールドを追加するか？ → A: optional で追加。領土名≠王朝名のケース（例: フランス王国→ブルボン朝）で教育的価値が高い。領土名≈王朝名のケース（例: 唐、アッバース朝）では省略する

## データ再作成方針

### 現状のデータ品質

| 指標 | 値 |
|------|-----|
| 年ファイル数 | 50 |
| ユニーク領土数 | 202 |
| 総エントリ数 | 754 |
| リッチエントリ | 554 (73.5%) |
| スカスカエントリ（"不明" あり or facts≤2 + events=0） | 200 (26.5%) |

### 方針

既存の領土情報データ（`public/data/descriptions/*.json`）をすべて削除し、**高校世界史の教科書に登場するレベルの主要な国家・帝国**（目標: **50〜70領土**）に絞って新しい構造化フォーマットで再作成する。

### データ管理方針

- **マスターデータ**: Notion データベースを正（Single Source of Truth）とする
- **データパイプライン**: Notion API (`@notionhq/client`) でデータを取得し、JSON に変換して `public/` ディレクトリに保存するコマンドを作成する
- **人的レビュー**: データ再作成（ユーザーストーリー6）は、実装前に Notion 上のデータの人的レビュー・承認を経てから進める
- **記述言語**: すべてのデータコンテンツ（profile の値、context テキスト、keyEvents の説明）は日本語で記述する

### 選定基準

以下の基準で対象領土を選定する:

1. **教科書基準**: 高校世界史の教科書で名前が挙がる国家・帝国・文明であること
2. **地域バランス**: ヨーロッパに偏らず、アジア、アフリカ、中東、南北アメリカの主要な政治体も含めること
3. **時代カバレッジ**: 古代〜現代まで各時代の主要な政治体をカバーすること
4. **データ品質**: すべての選定領土で、profile の主要フィールド（少なくとも首都・政体・指導者）、context（客観的事実による文章）、keyEvents（3件以上）を持つこと

### 対象外

- 植民地の細分化（例: "Cuba (Spain)", "Ceylon (Dutch)", "Dutch Brazil"）— 宗主国の情報に含める
- データソースが乏しく教科書にも登場しない小領土
- "不明" だらけの現在のスカスカエントリ

## ユーザーシナリオ & テスト *(必須)*

### ユーザーストーリー 1 - 領土のすばやい識別 (優先度: P1)

地図を探索中のユーザーが領土をクリックし、詳細情報を読まなくても、その名前とその時点における政治体制の性質を即座に確認できる。

**この優先度の理由**: 最も頻度の高いインタラクション。クリックの多くは探索的であり、ユーザーは「これは何？」を知ったうえで、さらに読むかどうかを判断したい。回答は即座かつスキャン可能でなければならない。

**独立テスト**: 任意の領土をクリックし、パネルヘッダーに領土名、時代ラベル、選択年が表示されることを確認することで完全にテスト可能。

**受け入れシナリオ**:

1. **前提** タイムラインで1700年を選択している、**操作** フランスの領土をクリックする、**結果** パネルヘッダーに領土名（例: "フランス"）、時代ラベル（例: "絶対王政期"）、年 "1700年" が表示される。
2. **前提** データの少ない領土（例: "Arakan"）をクリックする、**操作** パネルが開く、**結果** ヘッダーには領土名と年が表示され、時代ラベルはデータがなければ省略される。"不明" の値はどこにも表示されない。
3. **前提** モバイルデバイスを使用している、**操作** 領土をタップする、**結果** ボトムシートのヘッダーに同じ識別情報がコンパクトなレイアウトで表示される。

---

### ユーザーストーリー 2 - 構造化されたプロフィール概要 (優先度: P1)

ユーザーが領土の基本的な特徴（首都、政体、指導者など）を、すべての領土で一貫した構造を持つ、明確でスキャンしやすい形式で理解したい。

**この優先度の理由**: 識別の次に最も多い情報ニーズ。自由テキストではなくキー・バリューのペアに構造化することで、一貫したスキャンパターンが可能になり、将来のフィルタリングや比較機能もサポートできる。

**独立テスト**: データが豊富な領土（例: フランス 1700年）をクリックしてプロフィールフィールドがラベル付きキー・バリューペアで表示されることを確認し、データの少ない領土をクリックして不明なフィールドが "不明" ではなく省略されていることを確認する。

**受け入れシナリオ**:

1. **前提** データが豊富な領土（例: フランス 1700年）がある、**操作** パネルが表示される、**結果** プロフィール情報がラベル付きキー・バリューペアとして表示される（例: "首都: パリ", "政体: 絶対王政", "君主: ルイ14世"）。
2. **前提** 首都のみが判明している領土がある、**操作** パネルが表示される、**結果** 首都フィールドのみが表示され、その他のフィールドは完全に省略される（"不明" の項目なし）。
3. **前提** ユーザーが複数の領土を順番に閲覧する、**操作** 比較する、**結果** プロフィールフィールドがすべての領土で一貫した順序（首都 → 政体 → 王朝 → 指導者 → 宗教）で表示される。

---

### ユーザーストーリー 3 - 選択年における時代文脈 (優先度: P2)

特定の歴史的時代を学んでいるユーザーが、選択した時点でその領土に何が起きていたかを理解したい — 静的な属性だけでなく、時間的な状況（直近のイベント、進行中の動向、差し迫った変化）を含む。

**この優先度の理由**: 静的なプロフィールデータとフルタイムラインの間をつなぐ情報。「この年、ここで何が起きていたのか？」という歴史学習者にとって核心的な問いに答える。著作権への配慮から、客観的事実のみで構成された文章として提示する。

**独立テスト**: 特定の年で領土を表示し、文脈テキストがその年に固有の時間的状況を記述していることを確認する。静的なプロフィールフィールドとは異なる内容であること。

**受け入れシナリオ**:

1. **前提** 1700年でフランスが選択されている、**操作** 文脈セクションが表示される、**結果** その時代に固有の客観的事実が文章形式で表示される（例: "1700年のフランスはルイ14世の親政期にあり、ヨーロッパ最大の人口約2000万人を擁した。翌1701年にはスペイン継承戦争が勃発する。"）。
2. **前提** 領土に時代文脈データがない、**操作** パネルが表示される、**結果** 文脈セクションは空のセクションを表示するのではなく、完全に省略される。
3. **前提** 文脈データがある、**操作** 表示される、**結果** 文章が客観的な事実（日付、イベント名、定量的な状態とそれらの因果関係・時間的前後関係）のみで構成されており、主観的な評価や文学的修辞を含まない。

---

### ユーザーストーリー 4 - 時間的方向付けのあるタイムライン (優先度: P2)

ユーザーが領土の歴史的な流れを理解したい。選択年を基準にして、すでに起きたイベントと将来起きるイベントが明確に視覚的に区別される。

**この優先度の理由**: 現在のタイムラインは過去と未来のイベントを区別せずに混在させており、時系列の把握を難しくしている。選択年を基準にイベントをマーキングすることで、本質的な時間的方向付けを提供する。

**独立テスト**: フランスを1700年で選択し、タイムラインで1700年より前のイベント（例: 1643年 "ルイ14世即位"）が1700年より後のイベント（例: 1789年 "フランス革命"）と視覚的に異なることを確認する。

**受け入れシナリオ**:

1. **前提** 1700年でフランスが選択されている、**操作** タイムラインが表示される、**結果** 1700年より前のイベントは「過去」として視覚的にマーク（例: 薄い表示）、1700年付近のイベントは「現在」として強調、1700年より後のイベントは「未来」としてマーク（例: 破線/薄い表示）される。
2. **前提** 選択年がタイムライン上の2つのイベントの間にある、**操作** 表示される、**結果** 正確にその年のイベントがなくても、選択年の位置がタイムライン上に示される。
3. **前提** 領土にキーイベントがない、**操作** パネルが表示される、**結果** タイムラインセクションは完全に省略される。

---

### ユーザーストーリー 5 - レスポンシブな情報優先度 (優先度: P3)

モバイルデバイスの限られた画面スペースにおいて、パネルは情報を優先度順に表示し、ユーザーが最も重要な情報を最初に確認し、詳細は展開して閲覧できるようにする。

**この優先度の理由**: モバイルユーザーはビューポートが制約されており、インタラクションパターンも異なる（タップ vs スクロール）。デスクトップレイアウトを単に縮小するのではなく、情報密度をデバイスに適応させる必要がある。

**独立テスト**: モバイルビューポートでデータが豊富な領土のボトムシートを開き、ヘッダーとプロフィールが即座に表示され、文脈とタイムラインがスクロールまたは展開操作でアクセスできることを確認する。

**受け入れシナリオ**:

1. **前提** モバイルユーザーが領土をタップする、**操作** ボトムシートが初期ピーク高さで表示される、**結果** ヘッダー（名前、時代、年）とプロフィールフィールドがスクロールなしで表示される。
2. **前提** ボトムシートが展開される、**操作** 下にスクロールする、**結果** 文脈とタイムラインのセクションが優先度順に表示される。
3. **前提** モバイルでデータの少ない領土が表示される、**操作** 表示される、**結果** ボトムシートの高さが利用可能なコンテンツに適応し、空白スペースが表示されない。

---

### ユーザーストーリー 6 - 教科書レベルの主要領土データ品質 (優先度: P1)

世界史を学んでいるユーザーが、教科書に登場する主要な国家・帝国をクリックした際に、必ず有意義な情報が得られる。「首都: 不明、政体: 不明」のような無意味な表示がなく、学習の役に立つ情報が提供される。

**この優先度の理由**: いくら UI を改善しても、データの品質が低ければ学習体験は改善しない。主要領土のデータ品質を保証することは、他のすべてのユーザーストーリーの前提条件である。

**独立テスト**: 任意の年ファイルを開き、含まれるすべての領土が構造化プロフィール（少なくとも2フィールド）、文脈テキスト、キーイベント（1件以上）を持つことを確認する。"不明" を含むエントリが存在しないことを確認する。

**受け入れシナリオ**:

1. **前提** 既存のデータファイルがすべて削除されている、**操作** 新しいフォーマットでデータが再作成される、**結果** すべてのデータファイルが新しい構造化フォーマット（profile, context, keyEvents）に従っている。
2. **前提** 任意の年ファイルを確認する、**操作** 含まれる領土を確認する、**結果** 高校世界史の教科書に登場するレベルの主要な国家・帝国のみが含まれ、すべてが有意義なデータを持つ。
3. **前提** 任意のデータファイルを確認する、**操作** 全エントリのフィールドを検査する、**結果** "不明" という値を含むフィールドが存在しない。データがない場合はフィールド自体が省略されている。

---

### エッジケース

- 領土が地図上に存在するがデータフィールドがゼロ（プロフィールなし、文脈なし、イベントなし）の場合は？ → 領土名と年のみ表示。空のセクションや "不明" ラベルなし。
- 同じ領土で年によってデータ品質が大きく異なる場合（例: 1700年は豊富、1300年はスカスカ）は？ → 各年は独立。表示はその年の利用可能なデータに適応する。
- ユーザーが複数の領土を素早く連続クリックした場合は？ → 最後にクリックされた領土のパネルのみ表示。以前のフェッチは破棄される。
- 文脈テキストが keyEvents タイムラインの範囲外の年を参照する場合は？ → 文脈テキストは独立した事実記述であり、keyEvents のエントリと対応する必要はない。
- すべてのキーイベントが選択年に対して過去のみ、または未来のみの場合は？ → タイムラインは適切な時間的スタイリングで描画され、選択年マーカーは先頭または末尾に表示される。

## 要件 *(必須)*

### 機能要件

- **FR-001**: データモデルは、自由テキストではなく名前付きキー・バリューペアとして構造化されたプロフィールフィールドをサポートしなければならない（MUST）。
- **FR-002**: データモデルは、選択年におけるその領土の歴史的時代を示す短いラベルとしての `era` フィールド（文字列、オプション）を含まなければならない（MUST）。
- **FR-003**: データモデルは、選択年におけるその領土の時間的状況を客観的事実のみで記述する文章形式の `context` フィールド（文字列、2〜3文・100〜200字程度）を含まなければならない（MUST）。
- **FR-004**: タイムラインの各キーイベントは、選択年に対して `past`（過去）、`current`（現在: 選択年とイベント年が完全一致する場合のみ）、`future`（未来）として分類可能でなければならない（MUST）。
- **FR-005**: パネルは、データが利用できないプロフィールフィールド、文脈セクション、タイムラインセクションについて、プレースホルダーや "不明" 値を表示するのではなく、そのセクション自体を省略しなければならない（MUST）。
- **FR-006**: プロフィールフィールドは、すべての領土で一貫した順序（首都 → 政体 → 王朝 → 指導者 → 宗教）で表示されなければならない（MUST）。
- **FR-007**: タイムラインは、選択年に対する過去のイベント、現在のイベント、未来のイベントを視覚的に区別しなければならない（MUST）。
- **FR-008**: パネルは、AI 生成データが表示される場合、AI 生成コンテンツの注意書きを表示しなければならない（MUST）。
- **FR-009**: モバイルデバイスでは、ボトムシートの初期ピーク高さでヘッダーとプロフィール情報がスクロールなしで表示されなければならない（MUST）。
- **FR-010**: 文脈テキストは、客観的な事実（日付、イベント名、定量的な状態とそれらの因果関係・時間的前後関係）のみで構成された文章でなければならず、主観的な評価や文学的修辞を含んではならない（MUST）。
- **FR-011**: 既存の領土情報データファイル（`public/data/descriptions/*.json`）はすべて削除し、新しい構造化フォーマットで再作成しなければならない（MUST）。
- **FR-012**: 再作成するデータは、高校世界史の教科書に登場するレベルの主要な国家・帝国に限定しなければならない（MUST）。植民地の細分化や教科書に登場しない小領土は含めない。
- **FR-013**: 再作成するデータは地域バランスを確保し、ヨーロッパ、アジア、中東、アフリカ、南北アメリカの各地域の主要な政治体を含まなければならない（MUST）。
- **FR-014**: すべてのデータエントリは "不明" という値を含んではならない（MUST NOT）。データが不明な場合はそのフィールド自体を省略する。
- **FR-015**: すべてのデータコンテンツ（profile の値、context テキスト、keyEvents の説明）は日本語で記述しなければならない（MUST）。
- **FR-016**: Notion データベースをマスターデータとし、Notion API でデータを取得して JSON へ変換し `public/` ディレクトリに保存するデータ同期コマンドを提供しなければならない（MUST）。
- **FR-017**: 再作成するデータの目標領土数は 50〜70 領土とする（SHOULD）。

### キーエンティティ

- **TerritoryDescription**: 特定の年における領土の情報を表すコアデータエンティティ。識別情報（名前、年、時代）、構造化プロフィール（首都、政体、指導者など）、時代文脈（客観的事実による文章）、歴史タイムライン（キーイベント）を含む。
- **Profile**: 現在の非構造化 `facts` 配列を置き換える、オプションの名前付きフィールド（首都、政体、王朝、指導者、宗教）を持つ構造化サブエンティティ。
- **KeyEvent**: 年とイベントの説明を持つタイムラインイベント。時間的関係（past/current/future）は表示時に選択年から算出される。

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: ユーザーが領土をクリックしてから2秒以内に、本文を読まずに領土名と歴史的時代を識別できる。
- **SC-002**: 領土パネルに "不明" の値が表示されない。不明なフィールドは完全に省略される。
- **SC-003**: すべての領土のプロフィールフィールドの100%が、同じ構造化キー・バリュー形式と表示順序に従う。
- **SC-004**: ユーザーがタイムラインの過去・現在・未来のイベントを、視覚的な区別のみで識別できる（年を手動で比較する必要がない）。
- **SC-005**: モバイルデバイスのボトムシート初期ピーク高さで、領土名、時代ラベル、少なくとも2つのプロフィールフィールドがスクロールなしで表示される。
- **SC-006**: すべての文脈テキストが、客観的事実のみで構成された文章であり、主観的な評価や文学的修辞を含まない。
- **SC-007**: すべてのデータエントリが新しい構造化フォーマット（profile, context, keyEvents）に従い、旧フォーマット（facts 配列）のエントリが存在しない。
- **SC-008**: データに "不明" という値を含むエントリが0件である。

## 前提条件

- 既存のデータファイルはすべて削除し、新規に作成する（マイグレーションではなく再作成）。
- `era` フィールドと `context` フィールドは、既存のデータフィールドと同じ生成パイプラインを使用して AI 生成される。
- キーイベントの時間的関係（`past`/`current`/`future`）は、データファイルに保存するのではなく、イベント年と選択年から表示時に算出される。
- プロフィールフィールドのセット（首都、政体、王朝、指導者、宗教）は初回リリースとして十分である。追加フィールドは将来のイテレーションで追加可能。
- 人口データは前近代において推定値の幅が大きく、プロフィールフィールドとしては不適切と判断。重要な場面では context テキストで文脈と共に記述する。
- 外部リンク（例: Wikipedia）はこのイテレーションのスコープ外とする。
