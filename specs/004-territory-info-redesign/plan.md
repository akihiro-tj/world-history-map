# 実装計画書: 領土情報パネル リデザイン

**ブランチ**: `004-territory-info-redesign` | **日付**: 2026-03-01 | **仕様書**: [spec.md](./spec.md)
**入力**: `/specs/004-territory-info-redesign/spec.md` の機能仕様書

## 概要

領土情報パネルのデータモデルと UI を再設計する。非構造化の `facts: string[]` を構造化された `profile` フィールドに置き換え、`era`（時代ラベル）と `context`（時代文脈）フィールドを追加し、タイムラインイベントに選択年に対する時間的分類（過去/現在/未来）を導入する。データソースを静的な AI 生成 JSON から Notion データベース（Single Source of Truth）に移行し、CLI 同期コマンドを作成する。既存の説明データをすべて削除し、教科書レベルの主要 50〜70 領土を新フォーマットで再作成する。

## 技術コンテキスト

**言語/バージョン**: TypeScript 5.9.x (strict mode) + React 19.x, Node.js 22.x LTS
**主要依存関係**: React 19.x, MapLibre GL JS 5.x, react-map-gl 8.x, Tailwind CSS v4, clsx, tailwind-merge, @notionhq/client（新規）
**ストレージ**: ローカルファイルシステム (`public/data/descriptions/`) + Notion データベース（マスターデータ）
**テスト**: Vitest 4.x + @testing-library/react + Playwright 1.57.x
**対象プラットフォーム**: Web（デスクトップ + モバイルブラウザ）
**プロジェクトタイプ**: web（モノレポ: apps/frontend + apps/pipeline + apps/worker）
**パフォーマンス目標**: 地図操作 60fps、クリック後 2 秒以内の領土識別
**制約**: WCAG 2.1 AA、データに "不明" 値なし、すべてのコンテンツは日本語
**規模/スコープ**: 50 年ファイルにわたる 50〜70 領土、総エントリ数 750〜1500 件
**UI 実装ツール**: UI コンポーネントの新規作成・変更時は `/ui-ux-pro-max` スキルを使用すること

## コンスティチューションチェック

*ゲート: Phase 0 リサーチ前に合格必須。Phase 1 設計後に再チェック。*

### Phase 0 前チェック

| 原則 | 状態 | 備考 |
|------|------|------|
| I. テストファースト | PASS | データバリデーションスキーマ、イベント分類ロジック、UI コンポーネントに TDD 適用 |
| II. シンプルさと型安全性 | PASS | Notion API + MCP で読み書き一貫。strict なオプション型。`any` なし |
| III. コンポーネント駆動とアクセシビリティ | PASS | 再利用可能なプロフィール/タイムライン/コンテキストコンポーネント。WCAG 2.1 AA。複合的な視覚的手がかり |
| IV. 歴史的正確性と出典明記 | PASS | Notion データベースを人的レビュー付き SSOT として使用。`<AiNotice>` を UI に維持。データ実装前に人的レビュー必須（US-6） |
| V. パフォーマンスと継続的改善 | PASS | 仮想化不要（領土あたりイベント 20 件未満）。`useMemo` で分類計算。既存のプリフェッチ/キャッシュを維持 |

### Phase 1 後チェック

| 原則 | 状態 | 備考 |
|------|------|------|
| I. テストファースト | PASS | バリデーションスキーマテスト、分類ユニットテスト、コンポーネントテスト、E2E テストを計画 |
| II. シンプルさと型安全性 | PASS | 新規抽象化なし。新規依存は `@notionhq/client` のみ。Zod はパイプライン限定 |
| III. コンポーネント駆動とアクセシビリティ | PASS | `TerritoryProfile`, `TerritoryTimeline`, `TerritoryContext` を再利用可能なコンポーネントとして設計。セマンティック HTML `<ol>` + `aria-current` |
| IV. 歴史的正確性と出典明記 | PASS | 同期時にデータバリデーション（Zod スキーマが "不明" を拒否）。Notion データに人的レビューゲート |
| V. パフォーマンスと継続的改善 | PASS | バンドルサイズ不変（50 年ファイル）。分類は O(n) + useMemo。新規ネットワークリクエストなし |

違反なし。Complexity Tracking セクションは該当なし。

## プロジェクト構造

### ドキュメント（本機能）

```text
specs/004-territory-info-redesign/
├── plan.md              # 本ファイル
├── research.md          # Phase 0 出力 - 技術リサーチ
├── data-model.md        # Phase 1 出力 - エンティティ定義
├── quickstart.md        # Phase 1 出力 - 開発者ガイド
├── contracts/           # Phase 1 出力 - 型コントラクト
│   ├── territory-description.ts
│   └── validation-schema.ts
└── tasks.md             # Phase 2 出力 (/speckit.tasks コマンド)
```

### ソースコード（リポジトリルート）

```text
apps/
├── frontend/
│   ├── src/
│   │   ├── components/
│   │   │   ├── territory-info/
│   │   │   │   ├── territory-info-panel.tsx       # パネルレイアウト再設計
│   │   │   │   ├── territory-profile.tsx          # 新規: 構造化プロフィール表示
│   │   │   │   ├── territory-timeline.tsx         # 新規: 時間的タイムライン
│   │   │   │   ├── territory-context.tsx          # 新規: 文脈テキスト表示
│   │   │   │   ├── ai-notice.tsx                  # 既存（維持）
│   │   │   │   └── hooks/
│   │   │   │       └── use-territory-description.ts  # 新スキーマ対応に更新
│   │   │   └── ui/
│   │   │       └── bottom-sheet.tsx               # 既存（変更なし）
│   │   ├── types/
│   │   │   └── territory.ts                       # インターフェース更新
│   │   └── utils/
│   │       └── classify-events.ts                 # 新規: 時間的分類ロジック
│   ├── public/
│   │   └── data/
│   │       └── descriptions/                      # JSON ファイル再作成
│   └── tests/
│       └── e2e/                                   # Playwright テスト
├── pipeline/
│   └── src/
│       ├── cli.ts                                 # sync-descriptions コマンド追加
│       ├── config.ts                              # Notion 設定追加
│       └── stages/
│           ├── sync-descriptions.ts               # 新規: Notion → JSON 同期
│           └── validate-descriptions.ts           # 新規: Zod バリデーション
└── worker/                                        # 変更なし
```

**構造決定**: 既存のモノレポ構造（apps/frontend + apps/pipeline + apps/worker）を維持。変更はフロントエンド（UI + 型）とパイプライン（新規同期コマンド）にまたがる。新規プロジェクトやパッケージは追加しない。

## UI モックアップ

### Before / After 比較

**Before（現状）**: `facts: string[]` が非構造化リストとして表示される。

```text
┌──────────────────────────────────┐
│ フランス                1700年   │
├──────────────────────────────────┤
│                                  │
│ ● 首都: パリ                     │
│ ● 政体: 絶対王政                 │
│ ● 国家元首: ルイ14世             │
│ ● 人口: 不明                     │  ← "不明" が表示される
│ ● 備考: ヨーロッパ最大の…       │
│                                  │
│ 主な出来事                       │
│ 1643  ルイ14世即位               │  ← 過去/未来の
│ 1661  親政開始                   │     区別がない
│ 1682  ヴェルサイユ宮殿完成       │
│ 1789  フランス革命               │
│                                  │
│ ⓘ AI生成コンテンツ              │
└──────────────────────────────────┘
```

**After（新設計）**: 構造化プロフィール + 時代文脈 + 時間的分類タイムライン。

```text
┌──────────────────────────────────┐
│ フランス                         │
│ 絶対王政期              1700年   │  ← era ラベル追加
├──────────────────────────────────┤
│                                  │
│ ┌ プロフィール ────────────────┐ │
│ │ 首都     パリ                │ │  構造化 KV ペア
│ │ 政体     絶対王政            │ │  （固定順序）
│ │ 王朝     ブルボン朝          │ │  ← 新フィールド
│ │ 指導者   ルイ14世            │ │  "不明" は
│ │ 宗教     カトリック          │ │  フィールドごと省略
│ └──────────────────────────────┘ │
│                                  │
│ ┌ 時代の文脈 ─────────────────┐ │  ← 新セクション
│ │ 1700年のフランスはルイ14世の │ │
│ │ 親政期にあり、ヨーロッパ最大 │ │  客観的事実のみ
│ │ の人口約2000万人を擁した。翌 │ │  2〜3文
│ │ 1701年にはスペイン継承戦争が │ │  100〜200字
│ │ 勃発する。                   │ │
│ └──────────────────────────────┘ │
│                                  │
│ ┌ 主な出来事 ─────────────────┐ │
│ │ ○ 1643  ルイ14世即位        │ │  past: 薄い表示
│ │ ○ 1661  親政開始            │ │  past: 薄い表示
│ │ ○ 1682  ヴェルサイユ宮殿…  │ │  past: 薄い表示
│ │                              │ │
│ │         ── 1700年 ──        │ │  ← 選択年マーカー
│ │                              │ │
│ │ ◇ 1701  スペイン継承戦争…  │ │  future: 破線/薄い
│ │ ◇ 1789  フランス革命        │ │  future: 破線/薄い
│ └──────────────────────────────┘ │
│                                  │
│ ⓘ AI生成コンテンツ              │
└──────────────────────────────────┘
```

### デスクトップ: データリッチな領土（フランス 1700年）

```text
                    ┌─ w-96 (384px) ──────────────────────────────┐
                    │                                              │
  z-30              │  フランス                           ✕ 閉じる │
  fixed             │  絶対王政期                         1700年   │
  top-4 left-4      │                                              │
  backdrop-blur     ├──────────────────────────────────────────────┤
  bg-gray-700/95    │                                              │
  rounded-lg        │  首都     パリ                               │
  max-h-[calc(      │  政体     絶対王政                           │
    100vh-2rem)]    │  王朝     ブルボン朝                         │
  overflow-y-auto   │  指導者   ルイ14世                           │
                    │  宗教     カトリック                         │
                    │                                              │
                    │ ─────────────────────────────────────────── │
                    │                                              │
                    │  1700年のフランスはルイ14世の親政期にあり、  │
                    │  ヨーロッパ最大の人口約2000万人を擁した。    │
                    │  翌1701年にはスペイン継承戦争が勃発する。    │
                    │                                              │
                    │ ─────────────────────────────────────────── │
                    │                                              │
                    │  ○ 1643  ルイ14世即位          ┐            │
                    │  ○ 1661  親政開始              │ past       │
                    │  ○ 1682  ヴェルサイユ宮殿完成  ┘ (opacity)  │
                    │                                              │
                    │          ── 1700年 ──                        │
                    │                                              │
                    │  ◇ 1701  スペイン継承戦争勃発  ┐            │
                    │  ◇ 1789  フランス革命          ┘ future     │
                    │                                              │
                    │ ─────────────────────────────────────────── │
                    │  ⓘ この情報はAIによって生成されました。      │
                    │                                              │
                    └──────────────────────────────────────────────┘
```

### デスクトップ: データスパースな領土

```text
┌──────────────────────────────────────────────┐
│                                              │
│  アラカン                             1700年 │  era なし → 省略
│                                              │
├──────────────────────────────────────────────┤
│                                              │
│  首都     ムラウク・ウー                     │  profile: 1フィールドのみ
│                                              │  政体/王朝/指導者/宗教 → 省略
│                                              │
│                                              │  context なし → セクション省略
│                                              │  keyEvents なし → セクション省略
│                                              │
│ ─────────────────────────────────────────── │
│  ⓘ この情報はAIによって生成されました。      │
│                                              │
└──────────────────────────────────────────────┘

※ FR-005: データがないセクションは省略される。
   "不明" やプレースホルダーは表示されない。
```

### モバイル: BottomSheet 3段階スナップ

```text
 ┌─ Collapsed ──┐    ┌─── Half (40vh) ───┐    ┌── Expanded (90vh) ──┐
 │              │    │                    │    │                      │
 │              │    │                    │    │                      │
 │              │    │                    │    │                      │
 │              │    │                    │    │                      │
 │              │    │                    │    │                      │
 │              │    │                    │    ╔══════════════════════╗
 │              │    │                    │    ║  ──── handle         ║
 │              │    │                    │    ║ フランス       1700年║
 │              │    │                    │    ║ 絶対王政期           ║
 │              │    │                    │    ╠══════════════════════╣
 │              │    │                    │    │ 首都    パリ         │
 │              │    │                    │    │ 政体    絶対王政     │
 │              │    ╔════════════════════╗    │ 王朝    ブルボン朝   │
 │              │    ║  ──── handle       ║    │ 指導者  ルイ14世     │
 │              │    ║ フランス     1700年║    │ 宗教    カトリック   │
 │              │    ║ 絶対王政期         ║    │ ─── ── ── ── ───    │
 │              │    ╠════════════════════╣    │ 1700年のフランスは   │
 │              │    │ 首都    パリ       │    │ ルイ14世の親政期…   │
 │              │    │ 政体    絶対王政   │    │ ─── ── ── ── ───    │
 │              │    │ 王朝    ブルボン朝 │    │  ○ 1643 ルイ14…     │
 │              │    │ 指導者  ルイ14世   │    │  ○ 1661 親政…      │
 ╔══════════════╗    │ 宗教    カトリック │    │   ── 1700年 ──      │
 ║  ──── handle ║    │ ─── ── ── ── ───  │    │  ◇ 1701 スペ…      │
 ║ フランス     ║    │ 1700年のフランスは │    │  ◇ 1789 フラ…      │
 ║ 絶対王政期   ║    │ ルイ14世の親政期… │    │ ─── ── ── ── ───    │
 ║       1700年 ║    │         ↓ scroll   │    │ ⓘ AI生成コンテンツ   │
 ╚══════════════╝    └────────────────────┘    └──────────────────────┘

                     SC-005: 初期ピーク（half）
                     でヘッダー + プロフィールが
                     スクロールなしで表示される
```

### タイムライン: 時間的分類の視覚表現

```text
タイムラインの視覚的区別（FR-004, FR-007）

選択年 = 1700

  ┌─ past ────────────────────────────────────┐
  │                                            │
  │  ○ 1643  ルイ14世即位                     │  opacity-50
  │  │                                         │  text-gray-400
  │  ○ 1661  親政開始                         │
  │  │                                         │
  │  ○ 1682  ヴェルサイユ宮殿完成             │
  │  │                                         │
  └──┼─────────────────────────────────────────┘
     │
  ┌──┼─ current ──────────────────────────────┐
  │  │                                         │
  │  ● 1700  〇〇〇（該当イベントがある場合） │  opacity-100
  │  │                                         │  text-white
  │  │         or                               │  font-bold
  │  │                                         │  aria-current="step"
  │  ╌╌╌╌╌╌ ── 1700年 ── ╌╌╌╌╌╌              │  （完全一致のみ）
  │  │  （該当イベントがない場合は             │
  │  │    年マーカーのみ表示）                 │
  │  │                                         │
  └──┼─────────────────────────────────────────┘
     │
  ┌──┼─ future ───────────────────────────────┐
  │  │                                         │
  │  ◇ 1701  スペイン継承戦争勃発             │  opacity-50
  │  │                                         │  text-gray-400
  │  ◇ 1789  フランス革命                     │  border-dashed
  │                                            │
  └────────────────────────────────────────────┘

  凡例:
  ○  past イベント     （薄い表示）
  ●  current イベント  （強調表示、aria-current）
  ◇  future イベント   （薄い + 破線）
  ── 選択年マーカー    （current イベントがない場合）
```

### コンポーネント構成と情報優先度

```text
┌─ TerritoryInfoPanel ────────────────────────┐
│                                              │
│  ┌─ Header ───────────────────────────────┐ │  P1: 最優先
│  │  name: "フランス"                      │ │  US-1: すばやい識別
│  │  era:  "絶対王政期"  (optional)        │ │
│  │  year: 1700                            │ │
│  └────────────────────────────────────────┘ │
│                                              │
│  ┌─ TerritoryProfile ────────────────────┐  │  P1: 高優先
│  │  KV pairs (首都→政体→王朝→指導者→宗教)│  │  US-2: 構造化概要
│  │  データなし → セクション省略           │  │  FR-006: 固定順序
│  └────────────────────────────────────────┘  │
│                                              │
│  ┌─ TerritoryContext ────────────────────┐  │  P2: 中優先
│  │  context: string (2-3文, 100-200字)   │  │  US-3: 時代文脈
│  │  データなし → セクション省略           │  │  FR-010: 客観的事実のみ
│  └────────────────────────────────────────┘  │
│                                              │
│  ┌─ TerritoryTimeline ───────────────────┐  │  P2: 中優先
│  │  <ol> with aria-current="step"        │  │  US-4: 時間的方向付け
│  │  past / current / future 分類         │  │  FR-004, FR-007
│  │  データなし → セクション省略           │  │
│  └────────────────────────────────────────┘  │
│                                              │
│  ┌─ AiNotice (既存) ────────────────────┐  │  常に表示
│  │  ⓘ AI生成コンテンツの注意書き        │  │  FR-008
│  └────────────────────────────────────────┘  │
│                                              │
└──────────────────────────────────────────────┘
```

## Complexity Tracking

> コンスティチューションチェックの違反なし。このセクションは該当なし。
